<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" >
		<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
		<link href="lib/font-awesome/css/font-awesome.min.css" rel="stylesheet">
		<style type="text/css">
			html {
				height: 100%;
			}
			body {
				margin: 0;
				position: relative;
				height: 100%;
			}
			#map {
				left: 0px;
				top: 0px;
				right: 0px;
				bottom: 48px;
				position: absolute;
				background: #fee;
			}

			#bottomControls {
				position: absolute;
				left: 0px;
				right: 0px;
				height: 48px;
				bottom: 0px;
			}

				#bottomLeftControls {
					position: absolute;
					top: 0px;
					left: 0px;
					bottom: 0px;
					width: 144px;
				}

					#infoText {
						position: absolute;
						top: 0px;
						left: 0px;
						bottom: 0px;
						width: 96px;
						text-align: center;
						font-family: 'Courier New';
					}

					#playPauseButtons {
						position: absolute;
						top: 0px;
						left: 96px;
						bottom: 0px;
						right: 0px;
						text-align: 'right';
					}

						#playPauseButtons i {
							position: absolute;
							top: 9px;
							left: 11px;
						}

						#playPauseButtons #pauseButton {
							display: none;
						}

						#playPauseButtons.paused #playButton {
							display: none;
						}

						#playPauseButtons.paused #pauseButton {
							display: inline-block;
						}

				#scrollContainer {
					top: 0px;
					left: 144px;
					right: 0px;
					bottom: 0px;
					position: absolute;
					overflow: hidden;
				}
					#scrollCanvas {
						position: absolute;
						left: 0px;
						top: 0px;
						cursor: pointer;
					}
						#scrollHairLine {
							position: absolute;
							left: 50%;
							top: 0px;
							width: 1px;
							height: 48px;
							background: rgba(0,0,0,0.3);
						}
			.unselectable {
				-webkit-user-select: none;
				-moz-user-select: none;
				user-select: none;
			}
		</style>
		<script src="../data/data.js"></script>
		<script src="script/modules.js"></script>
		<script src="lib/jquery-1.11.0.min.js"></script>
		<script src="lib/leaflet/leaflet.js"></script>
		<script>
			$(function () {
				var scrollBar = new ScrollBar();
				var player = new Player();

				var activityList = [];
				data.activities.forEach(function (activity) {
					activity.cells = activity.cells.map(function (index) {
						return data.cells[index];
					})
					activityList[activity.index] = activity;
				})
				var index = 100;

				// create a map in the "map" div, set the view to a given place and zoom
				var map = L.map('map').setView([47.2, 8.3], 9);

				// add an OpenStreetMap tile layer
				L.tileLayer('http://tiles.odcdn.de/europe2/{z}/{x}/{y}.png', {
				}).addTo(map);

				var cellLayer = L.layerGroup();
				cellLayer.addTo(map);

				scrollBar.on('drag', function () {
					player.setTimeIndex(scrollBar.getTimeIndex());
				})

				scrollBar.on('dragStart', function () {
					player.pause();
				})

				scrollBar.on('dragEnd', function () {
					player.unpause();
				})

				player.on('change', function () {
					scrollBar.setTimeIndex(player.getTimeIndex());
				})

				player.on('change', function () {
					$('#infoText').html(formatDate(player.getDateTime()));
				})

				player.on('change', function () {
					var intervalSize = 12;

					var timeIndex = player.getTimeIndex();
					var i0 = timeIndex - intervalSize;
					var i1 = timeIndex + intervalSize;

					cellLayer.clearLayers();

					var used = {};
					for (var i = i0; i <= i1; i++) {
						var activity = activityList[i];
						if (activity) {
							var value = 1-Math.abs(activity.index-timeIndex)/(intervalSize+1);
							activity.cells.forEach(function (cell) {
								if (used[cell.id]) {
									if (used[cell.id].value < value) used[cell.id].value = value;
								} else {
									used[cell.id] = { value:value, cell:cell };
								}
							})
						}
					}

					Object.keys(used).forEach(function (id) {
						var color = used[id].value;
						color = 'rgba(255,'+Math.round(255*(1-color))+',0,'+color+')';
						var cell = used[id].cell;
						L.circle(
							[cell.y, cell.x],
							cell.acc,
							{
								weight: 1,
								color: color,
								fillColor: color,
								fillOpacity: 0.5
							}
						).addTo(cellLayer);
					});

				})

				player.on('start', function () {
					$('#playPauseButtons').addClass('paused');
				})

				player.on('stop', function () {
					$('#playPauseButtons').removeClass('paused');
				})

				$('#playButton').click(function () {
					player.start();
				})

				$('#pauseButton').click(function () {
					player.stop();
				})

				player.start();
			})

			function formatDate(value) {
				var d = new Date(value);
				d = ''+
					d.getDay() + '.' +
					(d.getMonth()+1) + '.' +
					d.getFullYear() + '<br>' +
					d.getHours() + ':' +
					d.getMinutes();
				return d;
			}
		</script>
	</head>
	<body class="unselectable">
		<div id="map"></div>
		<div id="bottomControls">
			<div id="bottomLeftControls">
				<div id="infoText">
				</div>
				<div id="playPauseButtons">
					<i id="playButton" class="fa fa-play fa-2x"></i>
					<i id="pauseButton" class="fa fa-pause fa-2x"></i>
				</div>
			</div>
			<div id="scrollContainer">
				<canvas id="scrollCanvas"></canvas>
				<div id="scrollHairLine"></div>
			</div>
		</div>
	</body>
</html>